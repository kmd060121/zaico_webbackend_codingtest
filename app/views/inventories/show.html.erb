<div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
  <h1>在庫詳細 #<%= @inventory.id %></h1>

  <div style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
    <p><strong>現在の在庫数:</strong> <%= @inventory.quantity %></p>
    <p><strong>会社ID:</strong> <%= @inventory.company_id %></p>
  </div>

  <div style="background: #fff; padding: 20px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 20px;">
    <h2>予定フリー在庫数の推移</h2>

    <div style="margin-bottom: 15px;">
      <label for="from-date">開始日:</label>
      <input type="date" id="from-date" value="<%= Date.today.strftime('%Y-%m-%d') %>">

      <label for="to-date" style="margin-left: 20px;">終了日:</label>
      <input type="date" id="to-date" value="<%= (Date.today + 30).strftime('%Y-%m-%d') %>">

      <button id="load-graph" style="margin-left: 20px; padding: 5px 15px;">グラフ更新</button>
    </div>

    <div id="response-time" style="margin-bottom: 10px; color: #666; font-size: 14px;"></div>

    <canvas id="logical-quantity-chart" style="max-height: 400px;"></canvas>
  </div>

  <div style="background: #f9f9f9; padding: 15px; border-radius: 5px; font-size: 14px;">
    <p><strong>API エンドポイント:</strong></p>
    <code>/api/inventories/<%= @inventory.id %>/logical_quantities.json?company_id=<%= @inventory.company_id %>&from=YYYY-MM-DD&to=YYYY-MM-DD</code>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  (function() {
    const inventoryId = <%= @inventory.id %>;
    const companyId = <%= @inventory.company_id %>;
    let chart = null;

    function loadGraph() {
      const fromDate = document.getElementById('from-date').value;
      const toDate = document.getElementById('to-date').value;
      const apiUrl = `/api/inventories/${inventoryId}/logical_quantities.json?company_id=${companyId}&from=${fromDate}&to=${toDate}`;

      const responseTimeDiv = document.getElementById('response-time');
      responseTimeDiv.textContent = 'Loading...';

      const startTime = performance.now();

      fetch(apiUrl)
        .then(response => {
          const endTime = performance.now();
          const responseTime = (endTime - startTime).toFixed(2);

          // レスポンスステータスを確認
          if (!response.ok) {
            return response.text().then(text => {
              console.error('API Error Status:', response.status);
              console.error('API Error Response:', text);
              throw new Error(`API returned status ${response.status}: ${text.substring(0, 100)}`);
            });
          }

          return response.json().then(data => ({ data, responseTime }));
        })
        .then(({ data, responseTime }) => {
          responseTimeDiv.innerHTML = `<strong>API レスポンスタイム:</strong> ${responseTime} ms`;

          const labels = data.points.map(point => point.date);
          const values = data.points.map(point => point.logical_quantity);

          const ctx = document.getElementById('logical-quantity-chart');

          if (chart) {
            chart.destroy();
          }

          chart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: '予定フリー在庫数',
                data: values,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.1,
                fill: true
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                title: {
                  display: true,
                  text: `予定フリー在庫数の推移 (在庫ID: ${inventoryId})`
                },
                legend: {
                  display: true
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: '数量'
                  }
                },
                x: {
                  title: {
                    display: true,
                    text: '日付'
                  }
                }
              }
            }
          });
        })
        .catch(error => {
          console.error('Error loading graph:', error);
          responseTimeDiv.innerHTML = `<strong style="color: red;">エラー:</strong> ${error.message}`;
        });
    }

    const loadButton = document.getElementById('load-graph');
    if (loadButton) {
      loadButton.addEventListener('click', loadGraph);
    }

    // 即座にグラフを読み込む
    loadGraph();
  })();
</script>
